{% extends "base.html" %}

{% block head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
{% endblock %}



{% block content %}

<main class="container mx-auto px-4 pt-24 pb-12">
    <div class="max-w-3xl mx-auto">
        <div class="mb-8 theme-card rounded-xl p-6 shadow-sm" data-aos="fade-up">
            <div class="flex justify-between items-center mb-4">
                <label class="text-sm font-medium text-gray-700">Mode de traitement</label>
                <div class="flex items-center space-x-3 bg-gray-100 px-3 py-1 rounded-lg pagination-container">
                    <button id="prevPage" class="text-gray-500 hover:text-indigo-600 p-1">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageIndicator" class="text-sm text-gray-600 min-w-[70px] text-center">
                        <span id="currentPage">1</span>/<span id="totalPages">1</span>
                    </span>
                    <button id="nextPage" class="text-gray-500 hover:text-indigo-600 p-1">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div id="modesContainer">
                {% set modes_per_page = 4 %}
                {% set total_modes = modes|length %}
                {% set total_pages = ((total_modes - 1) // modes_per_page) + 1 %}

                {% for page in range(total_pages) %}
                    <div id="modePage{{ page + 1 }}"
                         class="grid grid-cols-2 md:grid-cols-4 gap-3 {% if page != 0 %}hidden{% endif %}">
                        {% for mode_id, mode in modes.items() %}
                            {% if loop.index0 // modes_per_page == page %}
                                <button class="mode-button flex flex-col items-center justify-center p-4 rounded-xl border border-gray-200 hover:border-indigo-300 bg-white hover:bg-indigo-50 transition-all group"
                                        data-mode="{{ mode_id }}">
                                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mb-3 group-hover:bg-indigo-200 transition-colors">
                                        <i class="fas {{ mode.icon }} text-base text-indigo-600"></i>
                                    </div>
                                    <div class="text-sm font-medium text-gray-800 group-hover:text-indigo-600">{{ mode.title }}</div>
                                </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}

            </div>
        </div>


        <div class="theme-card rounded-xl p-6 shadow-sm mb-8" data-aos="fade-up" data-aos-delay="100">
            <label for="input_text" class="block text-sm font-medium text-indigo-200 mb-2">
                <i class="fas fa-pen-fancy mr-2 text-indigo-400"></i>Texte à traiter
            </label>
            <div class="relative">
<textarea id="input_text" name="input_text" rows="4"
          class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 resize-none floating-input"
          placeholder="Entrez votre texte ici...">{{ text_from_url }}</textarea>
                <button id="microphone-btn"
                        class="absolute right-3 top-3 p-2 text-gray-500 hover:text-indigo-600 transition-colors"
                        title="Transcrire un fichier audio">
                    <i class="fas fa-microphone"></i>
                </button>

                <input type="file"
                       id="audio-file"
                       accept="audio/*"
                       class="hidden"
                       onChange="handleAudioFile(this)">
            </div>
            <button id="submit-btn"
                    class="mt-4 w-full py-3 px-6 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors flex items-center justify-center shadow-lg hover:shadow-xl disabled:bg-indigo-400 disabled:hover:bg-indigo-400 disabled:cursor-not-allowed"
                    disabled>
                <i class="fas fa-magic mr-2"></i>
                Traiter le texte
            </button>
        </div>

        <div id="response-section" class="bg-white rounded-xl p-6 shadow-sm mb-8 hidden" data-aos="fade-up"
             data-aos-delay="100">
            <label for="response_text" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-reply mr-2 text-indigo-400"></i> Ce que vous voulez répondre
            </label>
            <textarea id="response_text" name="response_text" rows="4"
                      class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 resize-none floating-input"
                      placeholder="Entrez votre réponse ici..."></textarea>
        </div>

        <div id="loading" class="hidden theme-card rounded-xl p-6 shadow-sm" data-aos="fade-up" data-aos-delay="300">
            <div class="flex items-center justify-center space-x-6">
                <div class="network-loader">
                    <div class="particles">
                        <div class="particle p1"></div>
                        <div class="particle p2"></div>
                        <div class="particle p3"></div>
                        <div class="particle p4"></div>
                        <div class="particle p5"></div>
                        <div class="particle p6"></div>
                        <div class="rotator">
                            <div class="circle"></div>
                        </div>
                    </div>
                </div>
                <span class="text-gray-600 dark:text-indigo-200">Traitement en cours...</span>
            </div>
        </div>

        <div id="result" class="hidden theme-card rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700" data-aos="fade-up" data-aos-delay="200">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-indigo-200 flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    Résultat
                </h2>
                <button id="close-result" class="text-gray-500 dark:text-indigo-300 hover:text-gray-700 dark:hover:text-indigo-100 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="result-text" class="prose max-w-none mb-6 text-gray-700 bg-gray-50 rounded-xl p-4 border border-gray-200"></div>

            <div id="result-buttons" class="flex space-x-3">
                <button id="copy-button"
                        class="flex-1 px-4 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 transition-colors flex items-center justify-center shadow-md hover:shadow-lg">
                    <i class="fas fa-copy mr-2"></i> Copier
                </button>
                <button id="back-button"
                        class="flex-1 px-4 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors flex items-center justify-center shadow-md hover:shadow-lg">
                    <i class="fas fa-arrow-left mr-2"></i> Retour
                </button>
            </div>
        </div>

    </div>
</main>
<input type="hidden" id="selectedMode" name="mode" value="corriger">
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script>
    // Déplacer la fonction en dehors pour une portée globale
    function updateSubmitButton() {
        const inputText = document.getElementById('input_text');
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = !inputText.value.trim();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const inputText = document.getElementById('input_text');
        
        // Restore saved text
        const savedText = localStorage.getItem('autocorrect_input_text');
        if (savedText) {
            inputText.value = savedText;
        }
        
        // Mettre à jour l'état initial du bouton
        updateSubmitButton();
        
        // Update on input
        inputText.addEventListener('input', function() {
            localStorage.setItem('autocorrect_input_text', inputText.value);
            updateSubmitButton();
        });

        // Écoute du signal du pont pour le texte du presse-papiers
        new QWebChannel(qt.webChannelTransport, function(channel) {
            var pywebview = channel.objects.pywebview;
            pywebview.clipboard_text_signal.connect(function(text) {
                const clipboardBehavior = localStorage.getItem('clipboard_behavior') || 'ask';
                if (clipboardBehavior === 'always') {
                    inputText.value = text;
                    localStorage.setItem('autocorrect_input_text', text);
                    updateSubmitButton();
                } else if (clipboardBehavior === 'ask') {
                    Swal.fire({
                        title: 'Texte détecté dans le presse-papiers',
                        text: 'Voulez-vous coller le texte dans la zone de saisie ?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#6366f1',
                        cancelButtonColor: '#f87171',
                        confirmButtonText: 'Oui, coller',
                        cancelButtonText: 'Non, ignorer'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            inputText.value = text;
                            localStorage.setItem('autocorrect_input_text', text);
                            updateSubmitButton();
                        }
                    });
                }
                // Si 'never', on ne fait rien
            });
        });

    });
</script>
{% endblock %}
